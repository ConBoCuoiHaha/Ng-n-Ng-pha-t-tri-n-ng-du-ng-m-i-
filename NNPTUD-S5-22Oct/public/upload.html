<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Upload Ảnh & Avatar</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' ry='3' fill='%23666'/%3E%3Ctext x='8' y='11' font-size='9' text-anchor='middle' fill='white' font-family='Arial'%3EU%3C/text%3E%3C/svg%3E">
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 2rem; line-height: 1.5; }
      h1 { margin-bottom: 0.5rem; }
      section { border: 1px solid #ddd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
      form { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
      input[type="file"] { max-width: 320px; }
      .note { color: #555; font-size: 0.95rem; }
      .result { margin-top: 0.5rem; font-family: ui-monospace, Menlo, Consolas, monospace; }
      .preview { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
      .preview img { max-height: 120px; border: 1px solid #ddd; border-radius: 4px; }
      button { padding: 0.5rem 0.75rem; }
    </style>
  </head>
  <body>
    <h1>Upload Ảnh & Avatar</h1>
    <p class="note">Sử dụng các form bên dưới để tải ảnh lên server. Với avatar cần đăng nhập trước (cookie token).</p>

    <section>
      <h2>Đăng ký</h2>
      <form id="registerForm">
        <input type="text" name="username" placeholder="username (a-zA-Z0-9)" required />
        <input type="email" name="email" placeholder="email" required />
        <input type="password" name="password" placeholder="password mạnh" required />
        <button type="submit">Register</button>
      </form>
      <div class="note">Password cần: >=8 ký tự, có số, chữ thường, chữ hoa và ký tự đặc biệt.</div>
      <div class="result" id="registerResult"></div>
    </section>

    <section>
      <h2>Đăng nhập</h2>
      <form id="loginForm">
        <input type="text" name="username" placeholder="username" required />
        <input type="password" name="password" placeholder="password" required />
        <button type="submit">Login</button>
        <button type="button" id="logoutBtn">Logout</button>
      </form>
      <div class="result" id="loginResult"></div>
      <div class="result" id="meResult"></div>
    </section>

    <section>
      <h2>Upload 1 ảnh</h2>
      <form id="singleForm">
        <input type="file" name="image" accept="image/*" required />
        <button type="submit">Upload</button>
      </form>
      <div class="result" id="singleResult"></div>
      <div class="preview" id="singlePreview"></div>
    </section>

    <section>
      <h2>Upload nhiều ảnh</h2>
      <form id="multiForm">
        <input type="file" name="image" accept="image/*" multiple required />
        <button type="submit">Upload</button>
      </form>
      <div class="result" id="multiResult"></div>
      <div class="preview" id="multiPreview"></div>
    </section>

    <section>
      <h2>Upload avatar (yêu cầu đăng nhập)</h2>
      <form id="avatarForm">
        <input type="file" name="avatar" accept="image/*" required />
        <button type="submit">Upload avatar</button>
      </form>
      <div class="result" id="avatarResult"></div>
      <div class="preview" id="avatarPreview"></div>
    </section>

    <script>
      function getToken() {
        return localStorage.getItem('token') || '';
      }

      async function jsonPost(endpoint, body) {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(getToken() ? { 'Authorization': 'Bearer ' + getToken() } : {})
          },
          body: JSON.stringify(body),
          credentials: 'include'
        });
        const data = await res.json().catch(() => ({ success: false, data: 'Invalid JSON' }));
        return data;
      }

      async function fetchMe() {
        const res = await fetch('/auth/me', {
          credentials: 'include',
          headers: getToken() ? { 'Authorization': 'Bearer ' + getToken() } : {}
        });
        const data = await res.json().catch(() => ({}));
        const me = document.getElementById('meResult');
        me.textContent = data && data.success ? `Me: ${JSON.stringify(data.data)}` : 'Chưa đăng nhập';
      }

      async function upload(endpoint, formEl) {
        const formData = new FormData(formEl);
        const res = await fetch(endpoint, {
          method: 'POST',
          body: formData,
          credentials: 'include',
          headers: getToken() ? { 'Authorization': 'Bearer ' + getToken() } : {}
        });
        const data = await res.json().catch(() => ({ success: false, data: 'Invalid JSON' }));
        return data;
      }

      // Register
      document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const out = document.getElementById('registerResult');
        out.textContent = 'Đang đăng ký...';
        const result = await jsonPost('/auth/register', {
          username: fd.get('username'),
          email: fd.get('email'),
          password: fd.get('password'),
        });
        out.textContent = JSON.stringify(result, null, 2);
      });

      // Login
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const out = document.getElementById('loginResult');
        out.textContent = 'Đang đăng nhập...';
        const result = await jsonPost('/auth/login', {
          username: fd.get('username'),
          password: fd.get('password'),
        });
        out.textContent = JSON.stringify(result, null, 2);
        if (result && result.success && typeof result.data === 'string') {
          localStorage.setItem('token', result.data);
        }
        await fetchMe();
      });

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        const out = document.getElementById('loginResult');
        const res = await jsonPost('/auth/logout', {});
        out.textContent = JSON.stringify(res, null, 2);
        localStorage.removeItem('token');
        await fetchMe();
      });

      // Single
      document.getElementById('singleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const out = document.getElementById('singleResult');
        const prev = document.getElementById('singlePreview');
        out.textContent = 'Đang upload...';
        prev.innerHTML = '';
        const result = await upload('/files/uploads', e.target);
        out.textContent = JSON.stringify(result, null, 2);
        if (result.success && typeof result.data === 'string') {
          const img = document.createElement('img');
          img.src = result.data;
          prev.appendChild(img);
        }
      });

      // Multi
      document.getElementById('multiForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const out = document.getElementById('multiResult');
        const prev = document.getElementById('multiPreview');
        out.textContent = 'Đang upload...';
        prev.innerHTML = '';
        const result = await upload('/files/uploadMulti', e.target);
        out.textContent = JSON.stringify(result, null, 2);
        if (result.success && Array.isArray(result.data)) {
          result.data.forEach(url => {
            const img = document.createElement('img');
            img.src = url;
            prev.appendChild(img);
          });
        }
      });

      // Avatar
      document.getElementById('avatarForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const out = document.getElementById('avatarResult');
        const prev = document.getElementById('avatarPreview');
        out.textContent = 'Đang upload avatar...';
        prev.innerHTML = '';
        const result = await upload('/users/avatar', e.target);
        out.textContent = JSON.stringify(result, null, 2);
        const url = result && result.data && result.data.avatarURL;
        if (result.success && url) {
          const img = document.createElement('img');
          img.src = url;
          prev.appendChild(img);
        }
      });

      // Init
      fetchMe();
    </script>
  </body>
  </html>
